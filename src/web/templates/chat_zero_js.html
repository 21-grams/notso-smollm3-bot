<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmolLM3 Chat - Zero JS</title>
    <link rel="stylesheet" href="/static/css/chat-minimal.css">
    <!-- HTMX Core -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <!-- HTMX SSE Extension -->
    <script src="https://unpkg.com/htmx.org@1.9.10/dist/ext/sse.js"></script>
    <style>
        /* CSS-only auto-scroll trick */
        .chat-messages {
            overflow-y: auto;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }
        
        .chat-messages > *:last-child {
            scroll-margin-bottom: 0;
        }
        
        /* Focus-within trick to auto-scroll on new content */
        .chat-messages:focus-within {
            scroll-snap-type: y proximity;
        }
        
        .message:last-child {
            scroll-snap-align: end;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>SmolLM3 Chat</h1>
            <div class="system-status" 
                 hx-get="/api/status" 
                 hx-trigger="every 30s"
                 hx-swap="innerHTML">
                <span class="status-badge">Ready</span>
            </div>
        </div>
        
        <!-- Pure HTMX SSE implementation - NO JavaScript -->
        <div class="chat-messages" 
             id="chat-messages"
             hx-ext="sse"
             sse-connect="/api/stream/{{ session_id }}"
             tabindex="-1">
            
            <!-- Initial greeting -->
            <div class="message assistant">
                <div class="message-bubble">
                    Hello! I'm SmolLM3, ready to help. How can I assist you today?
                </div>
            </div>
            
            <!-- SSE swap target for message-start events -->
            <div id="sse-message-start" 
                 sse-swap="message-start"
                 hx-swap="beforeend"></div>
            
            <!-- SSE swap target for token events (appends to last message) -->
            <div id="sse-tokens" 
                 sse-swap="token"
                 hx-swap="beforeend"></div>
            
            <!-- SSE swap target for thinking events -->
            <div id="sse-thinking" 
                 sse-swap="thinking"
                 hx-swap="innerHTML"></div>
            
            <!-- SSE swap target for complete events -->
            <div id="sse-complete" 
                 sse-swap="complete"
                 hx-swap="innerHTML"></div>
            
            <!-- SSE swap target for error events -->
            <div id="sse-error" 
                 sse-swap="error"
                 hx-swap="beforeend"></div>
        </div>
        
        <!-- Status display updated via SSE -->
        <div class="status-display" 
             id="status-display"
             sse-swap="status"
             hx-swap="innerHTML">
            <!-- Status updates appear here -->
        </div>
        
        <div class="chat-input">
            <!-- Thinking mode toggle -->
            <div class="input-controls">
                <label class="thinking-toggle">
                    <input type="checkbox" 
                           name="thinking_mode"
                           hx-post="/api/toggle-thinking"
                           hx-trigger="change"
                           hx-vals='{"session_id": "{{ session_id }}"}'
                           hx-target="#thinking-status"
                           hx-swap="innerHTML"
                           {% if thinking_mode %}checked{% endif %}>
                    <span class="toggle-switch"></span>
                    <span id="thinking-status">Thinking Mode</span>
                </label>
                
                <!-- Token counter updated via SSE -->
                <div class="context-indicator">
                    <span class="context-text" 
                          id="context-text"
                          sse-swap="token-count"
                          hx-swap="innerHTML">0 / 2048 tokens</span>
                </div>
            </div>
            
            <!-- Pure HTMX form - absolutely ZERO JavaScript -->
            <form hx-post="/api/chat"
                  hx-target="#chat-messages"
                  hx-swap="beforeend"
                  hx-on::after-request="this.reset()">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                
                <!-- Using CSS resize instead of JS for textarea -->
                <textarea 
                    name="message"
                    placeholder="Type your message..."
                    required
                    autofocus
                    style="resize: vertical; min-height: 40px; max-height: 120px;"></textarea>
                
                <!-- Submit button triggers form submission -->
                <button type="submit">Send</button>
            </form>
        </div>
    </div>
</body>
</html>
